name: ðŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
      
      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
      
      - name: ðŸ”§ Configure SSH for Cloudflare Access
        run: |
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.SSH_HOST }}
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
            User ${{ secrets.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
      
      - name: ðŸ” Test Cloudflare Access
        run: |
          echo "Testing cloudflared access to ${{ secrets.SSH_HOST }}..."
          cloudflared access ssh --hostname ${{ secrets.SSH_HOST }} --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }} --url http://localhost:2222 &
          sleep 3
          echo "Cloudflared started, testing connection..."
      
      - name: ðŸš€ Deploy
        run: |
          ssh -T -o ConnectTimeout=30 ${{ secrets.SSH_HOST }} << 'ENDSSH'
            cd ${{ secrets.DEPLOY_PATH }}
            echo "ðŸ“ Directorio: $(pwd)"
            echo "ðŸ”„ Ejecutando deploy..."
            ./deploy.sh update
            echo "âœ… Deploy completado!"
          ENDSSH
      
      - name: âœ… Success
        if: success()
        run: echo "ðŸŽ‰ Deployment successful!"
      
      - name: âŒ Failure
        if: failure()
        run: echo "ðŸ’¥ Deployment failed! Check the logs above."
