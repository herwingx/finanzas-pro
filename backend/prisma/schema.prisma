generator client {
  provider   = "prisma-client-js"
}

// Force Rebuild 2026-01-15

datasource db {
  provider = "postgresql"
}

// ============ ENUMS ============

enum AccountType {
  CASH
  DEBIT
  CREDIT
  LOAN
  INVESTMENT
  SAVINGS
}

enum StatementStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
}

enum AssetType {
  REAL_ESTATE   // Bienes raíces
  VEHICLE       // Vehículos
  STOCK         // Acciones
  CRYPTO        // Criptomonedas
  BOND          // Bonos/Deuda
  FUND          // Fondos de Inversión
  ETF           // ETF
  CASH          // Efectivo bajo colchón
  COLLECTIBLE   // Arte, Joyas
  OTHER         // Otros
}

model User {
  id                    String                 @id @default(uuid())
  email                 String                 @unique
  password              String
  name                  String
  currency              String                 @default("MXN")
  timezone              String                 @default("America/Mexico_City")
  avatar                String?
  createdAt             DateTime               @default(now())
  resetToken            String?
  resetTokenExpiry      DateTime?
  
  // Perfil Financiero
  monthlyNetIncome      Float?                 @default(0) // Ingreso neto mensual (post-impuestos)
  incomeFrequency       String?                // weekly, biweekly, monthly
  taxRate               Float?                 // Tasa de impuestos estimada (0.0 - 1.0)
  netWorth              Float?                 @default(0) // Cache del patrimonio neto calculado
  financialScore        Int?                   @default(0) // Score de salud financiera (0-100)
  notificationsEnabled  Boolean                @default(true) // Notificaciones activas/desactivas
  
  // Relaciones
  accounts              Account[]
  assets                Asset[]
  investments           Investment[]
  budgets               Budget[]
  categories            Category[]
  installmentPurchases  InstallmentPurchase[]
  loans                 Loan[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]
  
  // Relaciones V2
  auditLogs             AuditLog[]
  savingsGoals          SavingsGoal[]
  notifications         Notification[]
  calendarEvents        CalendarEvent[]
  oauthAccounts         UserOAuth[]
  aiConversations       AIConversation[]
}

model Account {
  id                      String                    @id @default(uuid())
  name                    String
  type                    AccountType
  balance                 Float
  currency                String                    @default("MXN")
  creditLimit             Float?
  cutoffDay               Int?
  paymentDay              Int?
  interestRate            Float?                    // Tasa anual (ej: 45.0 para 45%)
  
  isArchived              Boolean                   @default(false)
  includeInNetWorth       Boolean                   @default(true)
  
  userId                  String
  user                    User                      @relation(fields: [userId], references: [id])
  
  installmentPurchases    InstallmentPurchase[]
  loans                   Loan[]
  recurringTransactions   RecurringTransaction[]
  transactions            Transaction[]
  destinationTransactions Transaction[]             @relation("DestinationTransactions")
  
  snapshots               AccountSnapshot[]
  statements              CreditCardStatement[]
}

model Asset {
  id              String         @id @default(uuid())
  name            String         // "Casa en la playa", "Tesla Model 3"
  type            AssetType
  ticker          String?        // Para Stocks/Crypto (AAPL, BTC)
  
  // Valoración
  purchasePrice   Float          // Valor de compra
  currentValue    Float          // Valor actual estimado
  currency        String         @default("MXN")
  quantity        Float          @default(1)
  
  // Detalles
  purchaseDate    DateTime
  location        String?        // Para Real Estate
  notes           String?
  
  isLiquid        Boolean        @default(false) // Si se puede convertir a efectivo rápido
  includeInNetWorth Boolean      @default(true)
  
  userId          String
  user            User           @relation(fields: [userId], references: [id])
  
  snapshots       AssetSnapshot[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([userId, type])
}

model Investment {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  type            String
  ticker          String?
  quantity        Float
  avgBuyPrice     Float
  currentPrice    Float
  currency        String    @default("MXN")
  purchaseDate    DateTime?
  lastPriceUpdate DateTime?
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
}

model Transaction {
  id                     String                   @id @default(uuid())
  amount                 Float
  description            String
  date                   DateTime
  type                   String                   // income, expense, transfer
  status                 String                   @default("completed") // completed, pending
  
  userId                 String
  categoryId             String?
  accountId              String?
  destinationAccountId   String?                  @map("destination_account_id")
  
  // Vínculos
  recurringTransactionId String?
  installmentPurchaseId  String?
  loanId                 String?
  statementId            String?
  
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  deletedAt              DateTime?
  
  account                Account?                 @relation(fields: [accountId], references: [id])
  category               Category?                @relation("CategoryTransactions", fields: [categoryId], references: [id])
  destinationAccount     Account?                 @relation("DestinationTransactions", fields: [destinationAccountId], references: [id])
  installmentPurchase    InstallmentPurchase?     @relation("InstallmentTransactions", fields: [installmentPurchaseId], references: [id])
  loan                   Loan?                    @relation(fields: [loanId], references: [id])
  recurringTransaction   RecurringTransaction?    @relation("RecurringTransactions", fields: [recurringTransactionId], references: [id])
  statement              CreditCardStatement?     @relation(fields: [statementId], references: [id])
  user                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([statementId])
  @@index([userId, date])
}

model InstallmentPurchase {
  id                    String        @id @default(uuid())
  description           String
  totalAmount           Float
  installments          Int
  monthlyPayment        Float
  purchaseDate          DateTime
  paidInstallments      Int           @default(0)
  paidAmount            Float         @default(0)
  
  status                String        @default("active") // active, completed
  
  accountId             String
  userId                String
  categoryId            String
  
  account               Account       @relation(fields: [accountId], references: [id])
  category              Category      @relation(fields: [categoryId], references: [id])
  user                  User          @relation(fields: [userId], references: [id])
  generatedTransactions Transaction[] @relation("InstallmentTransactions")
}

model Category {
  id                    String                 @id @default(uuid())
  name                  String
  icon                  String
  color                 String
  type                  String
  budgetType            String?                // needs, wants, savings
  userId                String
  
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  installmentPurchases  InstallmentPurchase[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]          @relation("CategoryTransactions")
  
  @@unique([name, userId])
}

model Budget {
  id        String   @id @default(uuid())
  name      String
  amount    Float
  startDate DateTime
  endDate   DateTime
  userId    String
  
  // Alertas
  notifyThreshold Int? // % al cual notificar (ej: 80)
  rollover        Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RecurringTransaction {
  id           String        @id @default(uuid())
  amount       Float
  description  String
  type         String
  frequency    String        // weekly, biweekly, monthly, yearly
  startDate    DateTime
  nextDueDate  DateTime
  endDate      DateTime?
  active       Boolean       @default(true)
  lastRun      DateTime?
  
  userId       String
  categoryId   String
  accountId    String
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  account      Account       @relation(fields: [accountId], references: [id])
  category     Category      @relation(fields: [categoryId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[] @relation("RecurringTransactions")
}

model Loan {
  id              String    @id @default(uuid())
  borrowerName    String    
  borrowerPhone   String?   
  borrowerEmail   String?   
  reason          String?   
  loanType        String    @default("lent") // "lent" (me deben), "borrowed" (debo)
  originalAmount  Float     
  remainingAmount Float     
  loanDate        DateTime  
  expectedPayDate DateTime? 
  status          String    @default("active") // active, partial, paid
  notes           String?   
  interestRate    Float?    // Tasa anual si aplica
  
  userId          String
  accountId       String?   
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account         Account?  @relation(fields: [accountId], references: [id])
  transactions    Transaction[] 
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============ PERSISTENCIA & HISTÓRICO ============

model CreditCardStatement {
  id              String          @id @default(uuid())
  accountId       String
  account         Account         @relation(fields: [accountId], references: [id])
  
  cycleStart      DateTime
  cycleEnd        DateTime
  paymentDueDate  DateTime
  
  totalDue        Float
  minimumPayment  Float?
  msiAmount       Float           @default(0)
  regularAmount   Float           @default(0)
  
  status          StatementStatus @default(PENDING)
  paidAmount      Float           @default(0)
  paidAt          DateTime?
  
  transactions    Transaction[]
  
  createdAt       DateTime        @default(now())
  
  @@index([accountId, cycleEnd])
}

model AccountSnapshot {
  id        String   @id @default(uuid())
  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  balance   Float
  date      DateTime
  
  @@unique([accountId, date])
  @@index([accountId, date])
}

model AssetSnapshot {
  id        String   @id @default(uuid())
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  value     Float
  date      DateTime // Snapshot a medianoche
  
  @@unique([assetId, date])
  @@index([assetId, date])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   
  entityType  String   
  entityId    String
  oldValue    Json?    
  newValue    Json?    
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
}

// ============ METAS & VARIOS ============

model SavingsGoal {
  id            String                @id @default(uuid())
  userId        String
  user          User                  @relation(fields: [userId], references: [id])
  
  name          String
  targetAmount  Float
  currentAmount Float                 @default(0)
  deadline      DateTime?
  icon          String?
  color         String?
  priority      Int                   @default(1) 
  status        String                @default("active") 
  
  contributions SavingsContribution[]
  
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
}

model SavingsContribution {
  id            String      @id @default(uuid())
  amount        Float
  date          DateTime
  notes         String?
  
  savingsGoalId String
  savingsGoal   SavingsGoal @relation(fields: [savingsGoalId], references: [id], onDelete: Cascade)
  transactionId String?     
  
  createdAt     DateTime    @default(now())
}

model UserOAuth {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider      String    
  providerId    String    
  accessToken   String?   
  refreshToken  String?   
  expiresAt     DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([provider, providerId])
}

model Notification {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type         String    
  title        String
  body         String
  data         Json?     
  read         Boolean   @default(false)
  
  scheduledFor DateTime? 
  sentAt       DateTime?
  
  createdAt    DateTime  @default(now())
  
  @@index([userId, read])
}

model CalendarEvent {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  externalId   String?  
  provider     String   
  title        String
  description  String?
  eventDate    DateTime
  
  recurringId   String?
  installmentId String?
  statementId   String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId, eventDate])
}

model AIConversation {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String?     
  messages  AIMessage[]
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model AIMessage {
  id             String         @id @default(uuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role           String         
  content        String
  tokens         Int?           
  
  createdAt      DateTime       @default(now())
  
  @@index([conversationId, createdAt])
}
